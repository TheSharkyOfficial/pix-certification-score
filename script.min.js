// Ce code permet l'affichage des informations de certification.
// Cr√©dit √† Yaya.Cout pour la d√©couverte de cette m√©thode. üòÅ

// Conditions bookmarklet
if (window.location.origin !== "https://app.pix.fr") {
  alert("Tu dois lancer ce programme sur ton espace personnel Pix.")
  throw new Error("Mauvais onglet")
}

// Lecture du token depuis le localStorage
let token
try {
  token = JSON.parse(localStorage.getItem("ember_simple_auth-session")).authenticated.access_token
} catch(e) {
  window.alert("Tu dois √™tre connect√© sur Pix.")
  throw new Error("Pas connect√© - token non trouv√©")
}

// Envoi de requ√™te
const req = new XMLHttpRequest()
req.addEventListener("load", reqListener)
req.open("GET", "https://app.pix.fr/api/certifications")
req.setRequestHeader("Authorization", `Bearer ${token}`)
req.send()

function reqListener() {
  const response = this.responseText
  
  // Traitement des donn√©es re√ßues
	const certifications = JSON.parse(response).data
	const notpublished = certifications.filter(certification => certification.attributes["is-published"] === false)

	// D√©tection de la page "Mes certifications" et remplissage direct
	if (window.location.pathname === "/mes-certifications") {
  	remplirSurPage(notpublished)
	} else {
    const centre = notpublished[0].attributes["certification-center"]
    if (notpublished[0].attributes["pix-score"] == 0) {
      window.alert(`Tu n'as malheureusement pas obtenu ta derni√®re certification. (${centre})`)
    } else {
      window.alert(`Tu as obtenu ta derni√®re certification avec ${notpublished[0].attributes["pix-score"]} points ! F√©licitations ! (${centre})`)
    }
  }
}

function remplirSurPage(notpublished) {
  for (let a = 0; a < notpublished.length; a++) {
    let id = notpublished[a].id
    let card = document.querySelector(`[data-testid="pw-certification-card-${id}"]`)
    card.style = "background-color: var(--pix-certif-300);"
    const tag = card.getElementsByClassName("pix-tag")[0]
    if (notpublished[a].attributes.status === "validated") {
      tag.classList = "pix-tag pix-tag--success"
      tag.innerText = "Obtenue"
      card.querySelector(".certification-item__hexagon > p").innerText = notpublished[a].attributes["pix-score"]
    } else {
      tag.classList = "pix-tag pix-tag--error"
      tag.innerText = "Non obtenue"
    }
  }
}
